<!DOCTYPE html>
<html>

<head>
    <title>Lex V2 챗봇 예제</title>
</head>

<body>
    <h1>Lex V2 챗봇 예제</h1>
    <div>
        <input type="text" id="userInput" placeholder="메시지를 입력하세요">
        <button onclick="handleUserInput()">보내기</button>
    </div>
    <div id="chatlog"></div>

    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1313.0.min.js"></script>
    <script>
        // AWS SDK import
        // AWS 설정
        AWS.config.update({
            region: 'ap-northeast-2',
            credentials: new AWS.Credentials('', '')
        });


        // 사용자 입력을 Lex 봇으로 전송하는 함수
        function sendUserInput(inputText) {
            // AWS Lex V2 클라이언트 생성
            const lexClient = new AWS.LexRuntimeV2();

            const params = {
                botId: '',
                botAliasId: '',
                localeId: 'ko_KR', // 봇의 언어 설정에 따라 다름
                sessionId: 'session-id',
                text: inputText
            };
            return lexClient.recognizeText(params).promise();
        }
        // 웹 페이지에서 사용자 입력을 받고, Lex 봇과 상호 작용하는 함수
        function handleUserInput() {
            const userInput = document.getElementById('userInput').value.trim();

            if (userInput !== '') {
                appendMessage('사용자', userInput);
                document.getElementById('userInput').value = '';
                // 사용자 입력을 Lex 봇에 보내기
                sendUserInput(userInput)
                    .then(response => {
                        // Lex의 응답 처리
                        const botMessage = response.messages[0].content;
                        sendToServer(botMessage)
                            .then(data => {
                                // 서버로부터 받은 응답 처리
                                console.log(data);
                                appendMessage('챗봇', data.responseFromDatabase.information);
                            });
                    })
                    .catch(err => {
                        console.error('Error:', err);
                    });
            }
        }

        // 챗봇의 응답을 Flask 서버로 보내는 함수
        function sendToServer(botMessage) {
            console.log(botMessage);

            return fetch('', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ botMessage: botMessage })
            })
                .then(response => response.json());
        }

        // 대화 기록 표시 함수
        function appendMessage(sender, message) {
            var chatlog = document.getElementById('chatlog');
            var messageElement = document.createElement('div');
            messageElement.className = 'message';
            messageElement.innerText = '[' + sender + '] ' + message;
            chatlog.appendChild(messageElement);
        }
    </script>
</body>

</html>